<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.maritime.dao.ScoreMapper">
  <resultMap id="BaseResultMap" type="com.maritime.models.Score">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Wed Apr 19 22:55:14 CST 2017.
    -->
    <id column="sid" jdbcType="INTEGER" property="sid" />
    <result column="seid" jdbcType="INTEGER" property="seid" />
    <result column="ssid" jdbcType="INTEGER" property="ssid" />
    <result column="score" jdbcType="VARCHAR" property="score" />
    <result column="point" jdbcType="REAL" property="point" />
    <result column="is_active" jdbcType="BIT" property="isActive" />
    <result column="sdescription" jdbcType="VARCHAR" property="sdescription" />
    <result column="last_update_user" jdbcType="VARCHAR" property="lastUpdateUser" />
    <result column="last_update_dt" jdbcType="TIMESTAMP" property="lastUpdateDt" />

      <result column="cnumber" jdbcType="BIGINT" property="cnumber" />
      <result column="cname" jdbcType="VARCHAR" property="cname" />
      <result column="cpoint" jdbcType="REAL" property="cpoint" />
      <result column="term" jdbcType="VARCHAR" property="term" />
      <result column="aname" jdbcType="VARCHAR" property="aname" />
      <result column="ccategory" jdbcType="VARCHAR" property="ccategory" />
      <result column="ctype" jdbcType="VARCHAR" property="ctype" />
      <result column="examtype" jdbcType="VARCHAR" property="examtype" />
      <result column="ename" jdbcType="VARCHAR" property="ename" />
      <result column="totalscore" jdbcType="REAL" property="totalscore" />
      <result column="finalscore" jdbcType="VARCHAR" property="finalscore" />
      <result column="finalpoint" jdbcType="REAL" property="finalpoint" />
      <result column="tname" jdbcType="VARCHAR" property="tname" />
      <result column="chour" jdbcType="INTEGER" property="chour" />
      <result column="mapid" jdbcType="INTEGER" property="mapid" />
      <result column="eform" jdbcType="VARCHAR" property="eform" />
      <result column="eid" jdbcType="INTEGER" property="eid" />
      <result column="stid" jdbcType="BIGINT" property="stid" />
      <result column="sname" jdbcType="VARCHAR" property="sname" />
      <result column="snumber" jdbcType="BIGINT" property="snumber" />
      <result column="saname" jdbcType="VARCHAR" property="saname" />
      <result column="smname" jdbcType="VARCHAR" property="smname" />
      <result column="sclass" jdbcType="VARCHAR" property="sclass" />
      <result column="totalp" jdbcType="INTEGER" property="totalp" />
      <result column="greatp" jdbcType="INTEGER" property="greatp" />
      <result column="goodp" jdbcType="INTEGER" property="goodp" />
      <result column="okp" jdbcType="INTEGER" property="okp" />
      <result column="snpassp" jdbcType="INTEGER" property="snpassp" />
      <result column="bnpassp" jdbcType="INTEGER" property="bnpassp" />

  </resultMap>
  <sql id="Base_Column_List">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Wed Apr 19 22:55:14 CST 2017.
    -->
    sid, seid, ssid, score, point, is_active, sdescription, last_update_user, last_update_dt
  </sql>
  <select id="selectByPrimaryKey" parameterType="java.lang.Integer" resultMap="BaseResultMap">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Wed Apr 19 22:55:14 CST 2017.
    -->
    select 
    <include refid="Base_Column_List" />
    from maritime.score
    where sid = #{sid,jdbcType=INTEGER}
  </select>
    <select id="selectForFinalScore" parameterType="java.lang.Long" resultMap="BaseResultMap">
        select m.pid as mapid,
        c.conumber as cnumber,c.coname as cname,c.copoint as cpoint,c.cohour as chour,m.pterm as term,fin.ename as ename,
        fin.etotalscore as totalscore,a.aname as aname,cat.ldvalue as ccategory,typ.ldvalue as ctype,final.score as finalscore,final.point as finalpoint,
        t.tname as tname
        from maritime.scmapping m
        left join maritime.course c on m.pcid = c.coid and c.is_active = true
        left join maritime.examination fin on m.pcid = fin.ecid and m.pterm = fin.eterm and fin.is_active = true and fin.etype = 9
        left join maritime.score final on final.ssid = m.psid and final.seid = fin.eid and final.is_active = true
        left join maritime.student d on final.ssid = d.sid and d.is_active = true
        left join maritime.teacher t on t.tid = c.coteacher1 and t.is_active = true
        left join maritime.academy a on c.coacademy = a.aid
        left join maritime.listdata cat on c.cocategory = cat.ldid
        left join maritime.listdata typ on c.cotype = typ.ldid
        left join maritime.listdata examt on fin.etype = examt.ldid
        where m.psid =  #{sid,jdbcType=BIGINT} and m.is_active = true
    </select>
    <select id="selectForAllScore" parameterType="com.maritime.models.Score" resultMap="BaseResultMap">
        select s.score,round(cast(s.point as numeric),2),e.ename as ename,e.total_time as totaltime,
        e.etotalscore as totalscore,examt.ldvalue as examtype,form.ldvalue as eform
        from maritime.scmapping m
        left join maritime.examination e on m.pcid = e.ecid and m.pterm = e.eterm and e.is_active = true
        left join maritime.score s on s.ssid = m.psid and s.seid = e.eid and s.is_active = true
        left join maritime.student d on s.ssid = d.sid and d.is_active = true
        left join maritime.course c on e.ecid = c.coid and c.is_active = true
        left join maritime.listdata form on e.eform = form.ldid
        left join maritime.listdata examt on e.etype = examt.ldid
        where m.psid = #{ssid,jdbcType=BIGINT} and m.pid = #{mapid,jdbcType=BIGINT} and m.is_active = true
    </select>
    <select id="selectForTeacherPage" parameterType="java.lang.Long" resultMap="BaseResultMap">
        select e.eid as eid,c.conumber as cnumber,c.coname as cname,a.aname as aname,typ.ldvalue as ctype,cat.ldvalue as ccategory,c.copoint as cpoint,c.cohour as chour,
        e.eterm as term,e.ename as ename,e.total_time as totaltime,
        e.etotalscore as totalscore,examt.ldvalue as examtype,form.ldvalue as eform
        from maritime.examination e
        left join maritime.course c on e.ecid = c.coid and c.is_active = true
        left join maritime.academy a on a.aid = c.coacademy
        left join maritime.listdata form on e.eform = form.ldid
        left join maritime.listdata examt on e.etype = examt.ldid
        left join maritime.listdata cat on c.cocategory = cat.ldid
        left join maritime.listdata typ on c.cotype = typ.ldid
        where e.is_active = true and c.coteacher1 = #{tid,jdbcType=BIGINT}
    </select>
    <select id="selectForStudentScore" parameterType="com.maritime.models.Score" resultMap="BaseResultMap">
        select s.sid as ssid,s.sname as sname,s.snumber as snumber, a.aname as saname,
        maj.mname as smname,cla.cyear||'-'||cla.cnum as sclass,sc.score as score,round(cast(sc.point as numeric),2) as point,
        sc.sid as sid,e.eid as eid,sc.sdescription as sdescription,e.etotalscore as totalscore
        from maritime.student s
        left join maritime.scmapping m on m.psid = s.sid and m.is_active = true
        left join maritime.course c on m.pcid = c.coid and c.is_active = true
        left join maritime.examination e on e.ecid = c.coid and m.pterm = e.eterm and e.is_active = true
        left join maritime.score sc on s.sid = sc.ssid and sc.seid = e.eid and sc.is_active = true
        left join maritime.academy a on a.aid = s.sacademy
        left join maritime.major maj on maj.mid = s.smajor
        left join maritime.class cla on cla.cid = s.sclass
        where c.coteacher1 = #{tid,jdbcType=BIGINT} and e.eid = #{eid,jdbcType=INTEGER} and s.is_active = true
    </select>
    <select id="selectByExam" parameterType="java.lang.Integer" resultMap="BaseResultMap">
        select stu.snumber as snumber,stu.sname as sname,s.score,a.aname as saname,m.mname as smname,c.cnum as sclass
        from maritime.score s
        inner join maritime.student stu on s.ssid = stu.sid and stu.is_active = true
        left join maritime.academy a on stu.sacademy = a.aid
        left join maritime.major m on stu.smajor = m.mid
        left join maritime.class c on stu.sclass = c.cid
        where s.is_active = true and stu.is_active = true and s.seid = #{eid,jdbcType=INTEGER}
        order by stu.snumber
    </select>
    <select id="selectByTermsForGraphics" resultMap="BaseResultMap">
        select e.eterm as term,count(s.sid) as totalp,sum(case when cast(s.score as numeric) &gt;= e.etotalscore*0.9 then 1 else 0 end) as greatp,
        sum(case when cast(s.score as numeric) &gt;= e.etotalscore*0.7 and cast(s.score as numeric) &lt; e.etotalscore*0.9 then 1 else 0 end) as goodp,
        sum(case when cast(s.score as numeric) &gt;= e.etotalscore*0.6 and cast(s.score as numeric) &lt; e.etotalscore*0.7 then 1 else 0 end) as okp,
        sum(case when cast(s.score as numeric) &gt;= e.etotalscore*0.4 and cast(s.score as numeric) &lt; e.etotalscore*0.6 then 1 else 0 end) as snpassp,
        sum(case when cast(s.score as numeric) &lt; e.etotalscore*0.4 then 1 else 0 end) as bnpassp
        from maritime.score s
        left join maritime.examination e on s.seid = e.eid and e.is_active = true and e.etype = 9 and e.ecid = #{cid}
        where s.is_active = true and e.is_active = true and e.ecid = #{cid} and e.eterm in
        <foreach item="term" index="index" collection="term" open="("
                 separator="," close=")">
            #{term}
        </foreach>
        group by e.eterm
        order by e.eterm
    </select>
  <delete id="deleteByPrimaryKey" parameterType="java.lang.Integer">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Wed Apr 19 22:55:14 CST 2017.
    -->
    delete from maritime.score
    where sid = #{sid,jdbcType=INTEGER}
  </delete>
  <insert id="insert" parameterType="com.maritime.models.Score">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Wed Apr 19 22:55:14 CST 2017.
    -->
    insert into maritime.score (seid, ssid,
      score, point, is_active, sdescription, 
      last_update_user, last_update_dt)
    values (#{seid,jdbcType=INTEGER}, #{ssid,jdbcType=INTEGER},
      #{score,jdbcType=VARCHAR}, #{point,jdbcType=REAL}, #{isActive,jdbcType=BIT}, #{sdescription,jdbcType=VARCHAR}, 
      #{lastUpdateUser,jdbcType=VARCHAR}, #{lastUpdateDt,jdbcType=TIMESTAMP})
  </insert>

  <update id="updateByPrimaryKey" parameterType="com.maritime.models.Score">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Wed Apr 19 22:55:14 CST 2017.
    -->
    update maritime.score
    set
      <!--seid = #{seid,jdbcType=INTEGER},-->
      <!--ssid = #{ssid,jdbcType=INTEGER},-->
      score = #{score,jdbcType=VARCHAR},
      point = #{point,jdbcType=REAL},
      is_active = #{isActive,jdbcType=BIT},
      sdescription = #{sdescription,jdbcType=VARCHAR},
      last_update_user = #{lastUpdateUser,jdbcType=VARCHAR},
      last_update_dt = #{lastUpdateDt,jdbcType=TIMESTAMP}
    where sid = #{sid,jdbcType=INTEGER}
  </update>
</mapper>